apiVersion: tf.upbound.io/v1beta1
kind: Workspace
metadata:
  name: virtual-dev-cluster-2-bootstrap
  annotations:
    argocd.argoproj.io/sync-wave: "10"
    crossplane.io/external-name: virtual-dev-cluster-2-bootstrap
spec:
  providerConfigRef:
    name: virtual-dev-cluster-2
  forProvider:
    source: Inline
    module: |
      variable "cluster_name" {
        type = string
        default = "virtual-dev-cluster-2"
      }
      provider "kubernetes" {
        alias = "local"
      }
      data "kubernetes_secret_v1" "vcluster_kubeconfig" {
        provider = "kubernetes.local"
        metadata {
          name = "vc-virtual-dev-cluster-2"
          namespace = "virtual-dev-cluster-2"
        }
      }      

      resource "aws_ssm_parameter" "clusters" {
        provider    = aws.PROJECT_REGION
        name        = "/clusters/virtual-dev-cluster-2"
        description = "Cluster configuration for virtual-dev-cluster-2"
        type        = "String" 
        tier = "Advanced"

        value = jsonencode({
          kubeconfig              = data.kubernetes_secret_v1.vcluster_kubeconfig.data.config
          client_certificate      = base64decode(yamldecode(data.kubernetes_secret_v1.vcluster_kubeconfig.data.config).users[0].user.client-certificate-data)
          client_key              = base64decode(yamldecode(data.kubernetes_secret_v1.vcluster_kubeconfig.data.config).users[0].user.client-key-data)
          cluster_ca_certificate  = base64decode(yamldecode(data.kubernetes_secret_v1.vcluster_kubeconfig.data.config).clusters[0].cluster.certificate-authority-data)
          host                    = "https://virtual-dev-cluster-2.gitops.ing"
          cluster_name            = var.cluster_name  
          argocd_manager_sa_token = kubernetes_secret_v1.argocd_manager.data.token
        })
      }

      provider "kubernetes" {
        alias = "target"
        host = "https://virtual-dev-cluster-2.gitops.ing"

        client_certificate     = base64decode(yamldecode(data.kubernetes_secret_v1.vcluster_kubeconfig.data.config).users[0].user.client-certificate-data)
        client_key             = base64decode(yamldecode(data.kubernetes_secret_v1.vcluster_kubeconfig.data.config).users[0].user.client-key-data)
        cluster_ca_certificate = base64decode(yamldecode(data.kubernetes_secret_v1.vcluster_kubeconfig.data.config).clusters[0].cluster.certificate-authority-data)
      }

      resource "kubernetes_cluster_role_v1" "argocd_manager" {
        provider = "kubernetes.target"
        metadata {
          name = "argocd-manager-role"
        }

        rule {
          api_groups = ["*"]
          resources  = ["*"]
          verbs      = ["*"]
        }
        rule {
          non_resource_urls = ["*"]
          verbs = ["*"]
        }
      }


      resource "kubernetes_cluster_role_binding_v1" "argocd_manager" {
        provider = "kubernetes.target"
        metadata {
          name = "argocd-manager-role-binding"
        }
        role_ref {
          api_group = "rbac.authorization.k8s.io"
          kind      = "ClusterRole"
          name      = kubernetes_cluster_role_v1.argocd_manager.metadata.0.name
        }
        subject {
          kind      = "ServiceAccount"
          name      = kubernetes_service_account_v1.argocd_manager.metadata.0.name
          namespace = "kube-system"
        }
      }

      resource "kubernetes_service_account_v1" "argocd_manager" {
        provider = "kubernetes.target"
        metadata {
          name = "argocd-manager"
          namespace = "kube-system"
        }
        secret {
          name = "argocd-manager-token"
        }
      }

      resource "kubernetes_secret_v1" "argocd_manager" {
        provider = "kubernetes.target"
        metadata {
          name = "argocd-manager-token"
          namespace = "kube-system"
          annotations = {
            "kubernetes.io/service-account.name" = "argocd-manager"
          }
        }
        type = "kubernetes.io/service-account-token"
        depends_on = [ kubernetes_service_account_v1.argocd_manager ]
      }
